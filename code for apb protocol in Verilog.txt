//code for apb protocol in Verilog.


module apb_mst( input clk, 
	        input rst,
		input transfer,
		input [31:0] addr,
		input [31:0] wdata,
		input write,
		output reg psel,
		output reg [31:0] pwdata,
		output reg [31:0] paddr,
		output reg pwrite,
		output reg penable, 
		output reg pready);


		//states as parameter
		parameter idle = 2'b00;
		parameter setup = 2'b01;
		parameter access = 2'b10;


		//states
		reg [1:0] current_state,nxt_state;


		//to check the initial state 
		always @(posedge clk,negedge rst) begin
			if(!rst)
			  current_state <= idle;
			else
			  current_state <= next_state;
		end

		//actual fsm
		always @(*) begin
		case (current_state)
		   idle : begin
			  if(transfer)
			     next_state <= setup;
			  else
			     next_state <= idle;
			  end
		   setup : begin
				next_state <= access;
			   end	
		    
	           access : begin
			    if(pready)
				if(transfer)
					next_state <= setup;
				else
					next_state <= idle;
		            else
				next_state <= access;
		            end
		   default : next_state <= idle;
			
		end

		
		//output logic of fsm
		always @(posedge clk,negedge rst) begin
		if(!rst) begin
			psel <= 0;
			penable <= 0;
			paddr <= 0;
			pwdata <= 0;
			pwrite <= 0;
		end
		else begin
			case(next_state)
				idle : begin
				   psel <= 1'b0;
			           penable <= 1'b0;
				end
				
				setup : begin
				   psel <= 1'b1;
				   penable <= 1'b0;
				   paddr <= addr;
				   pwrite <= write;
				   pwdata <= wdata;
				end
				
				access : begin
				   psel <= 1'b1;
				   penable <= 1'b1;
				end

		end
endmodule